"""
æ°”è±¡é¢„è­¦æ¶ˆæ¯æ ¼å¼åŒ–å™¨
"""

from ...models.models import WeatherAlarmData
from .base import BaseMessageFormatter

# é¢„è­¦ç±»å‹åˆ°Emojiçš„æ˜ å°„
WEATHER_EMOJI_MAP = {
    # ä¸€ã€å›½å®¶çº§æ ‡å‡†é¢„è­¦ï¼ˆ14ç±»ï¼‰
    "å°é£": "ğŸŒ€",
    "æš´é›¨": "â›ˆï¸",
    "å¼ºå¯¹æµ": "â›ˆï¸âš¡",
    "æš´é›ª": "â„ï¸",
    "å¯’æ½®": "ğŸ¥¶",
    "å¤§é£": "ğŸƒ",
    "æ²™å°˜æš´": "ğŸœï¸ğŸŒªï¸",
    "ä½æ¸©": "ğŸŒ¡ï¸ğŸ“‰",
    "é«˜æ¸©": "ğŸŒ¡ï¸ğŸ”¥",
    "å¹²æ—±": "â˜€ï¸ğŸŒµ",
    "éœœå†»": "â„ï¸ğŸŒ¡ï¸",
    "å†°å†»": "ğŸ§Š",
    "å¤§é›¾": "ğŸŒ«ï¸",
    "éœ¾": "ğŸŒ«ï¸ğŸ˜·",
    # äºŒã€åœ°æ–¹ç‰¹è‰²åŠä¸“é¡¹é¢„è­¦
    # æµ·æ´‹æ°”è±¡é¢„è­¦
    "æµ·ä¸Šå¤§é£": "ğŸŒŠğŸ’¨",
    "æµ·ä¸Šå°é£": "ğŸŒŠğŸŒ€",
    "æµ·ä¸Šå¤§é›¾": "ğŸŒŠğŸŒ«ï¸",
    "æµ·ä¸Šé›·é›¨å¤§é£": "ğŸŒŠâ›ˆï¸ğŸ’¨",
    "æµ·ä¸Šé›·ç”µ": "ğŸŒŠâš¡",
    "é£æš´æ½®": "ğŸŒŠâ¬†ï¸",
    "æµ·æµª": "ğŸŒŠ",
    "æµ·å•¸": "ğŸŒŠâš ï¸",
    "å¼ºå­£é£": "ğŸŒ¬ï¸ğŸƒ",
    # åœ°åŸŸæ€§å¤©æ°”é¢„è­¦
    "é“è·¯å†°é›ª": "ğŸ›£ï¸ğŸ§Š",
    "é›ªç¾": "â„ï¸âš ï¸",
    "å¤§é›ª": "ğŸŒ¨ï¸",
    "æŒç»­ä½æ¸©": "ğŸŒ¡ï¸ğŸ“‰â³",
    "ä¸¥å¯’": "ğŸ¥¶",
    "ä½æ¸©å†»å®³": "ğŸ¥¶ğŸŒ±",
    "ä½æ¸©é›¨é›ªå†°å†»": "ğŸŒ¨ï¸ğŸ§Š",
    # ç¯å¢ƒä¸ç«é™©é¢„è­¦
    "æ£®æ—ï¼ˆè‰åŸï¼‰ç«é™©": "ğŸŒ²ğŸ”¥",
    "æ£®æ—ç«é™©": "ğŸŒ²ğŸ”¥",
    "è‰åŸç«é™©": "ğŸŒ±ğŸ”¥",
    "ç©ºæ°”é‡æ±¡æŸ“": "ğŸ­ğŸ˜·",
    "è‡­æ°§": "ğŸ§ª",
    "æµ“æµ®å°˜": "ğŸœï¸ğŸŒ«ï¸",
    "æ²™å°˜": "ğŸœï¸ğŸ’¨",
    "é‡æ±¡æŸ“å¤©æ°”": "ğŸŒ«ï¸ğŸ˜·",
    # å¼ºå¯¹æµç»†åˆ†é¢„è­¦
    "é›·ç”µ": "âš¡",
    "é›·æš´å¤§é£": "â›ˆï¸ğŸ’¨",
    "çŸ­æ—¶å¼ºé™æ°´": "ğŸŒ§ï¸ğŸš¤",
    "é¾™å·é£": "ğŸŒªï¸",
    "å†°é›¹": "ğŸŒ¨ï¸ğŸ§Š",
    # èƒ½è§åº¦ç±»ç»†åˆ†é¢„è­¦
    "è½»é›¾": "ğŸŒ«ï¸",
    "é‡é›¾": "ğŸŒ«ï¸ğŸŒ«ï¸",
    "æµ“é›¾": "ğŸŒ«ï¸ğŸŒ«ï¸ğŸŒ«ï¸",
    "ç‰¹å¼ºæµ“é›¾": "ğŸŒ«ï¸ğŸŒ«ï¸âš ï¸",
    # æ¸©åº¦ç±»è¡¥å……é¢„è­¦
    "å¯’å†·": "ğŸ§¥",
    "ä½æ¸©å†·å®³": "ğŸŒ¡ï¸ğŸ“‰ğŸ‚",
    "é«˜æ¸©ä¸­æš‘": "â˜€ï¸ğŸ¤¢",
    "å¹²çƒ­é£": "ğŸ”¥ğŸƒ",
    # åŸå¸‚ä¸ç¯å¢ƒä¸“é¡¹
    "ç°éœ¾": "ğŸŒ«ï¸",
    "è‡­æ°§æ±¡æŸ“": "ğŸ§ªâš ï¸",
    "å…‰åŒ–å­¦çƒŸé›¾": "ğŸŒ«ï¸ğŸ§ª",
    # å†œä¸šæ°”è±¡é¢„è­¦
    "å†œä¸šå¹²æ—±": "ğŸšœğŸŒµ",
    "å†œç”°æ¸æ¶": "ğŸšœğŸŒŠ",
    "ä½œç‰©éœœå†»": "ğŸŒ±â„ï¸",
    "å€’æ˜¥å¯’": "ğŸŒ±ğŸ¥¶",
    "å¯’éœ²é£": "ğŸ‚ğŸƒ",
    # æ°´æ–‡ä¸åœ°è´¨ç¾å®³é¢„è­¦
    "ä¸­å°æ²³æµæ´ªæ°´": "ğŸŒŠğŸ˜ï¸",
    "å±±æ´ªç¾å®³": "â›°ï¸ğŸŒŠ",
    "åœ°è´¨ç¾å®³": "â›°ï¸âš ï¸",
    # äº¤é€šæ°”è±¡é¢„è­¦
    "é“è·¯ç»“å†°": "ğŸ›£ï¸ğŸ§Š",
    "é“è·¯ç§¯é›ª": "ğŸ›£ï¸â„ï¸",
    "è·¯é¢é«˜æ¸©": "ğŸ›£ï¸ğŸ”¥",
    "èˆªé“ç»“å†°": "ğŸš¢ğŸ§Š",
    # ç‰¹æ®Šå¤©æ°”é¢„è­¦
    "é£‘çº¿": "ğŸŒ©ï¸ğŸ’¨",
    "å°˜å·é£": "ğŸŒªï¸",
    # åŸå¸‚å®šåˆ¶é¢„è­¦
    "åŸå¸‚å†…æ¶": "ğŸ™ï¸ğŸŒŠ",
    "å»ºç­‘å·¥åœ°": "ğŸ—ï¸âš ï¸",
    "æ—…æ¸¸æ™¯åŒº": "ğŸ•ï¸âš ï¸",
    # ç§‘ç ”ä¸ä½œä¸šé¢„è­¦
    "äººå·¥å½±å“å¤©æ°”": "ğŸš€â˜ï¸",
    "é£æœºç§¯å†°": "âœˆï¸ğŸ§Š",
}

# æŒ‰é•¿åº¦æ’åºï¼Œä¼˜å…ˆåŒ¹é…é•¿è¯
SORTED_WEATHER_TYPES = sorted(WEATHER_EMOJI_MAP.keys(), key=len, reverse=True)

# é¢„è­¦çº§åˆ«é¢œè‰²æ˜ å°„
COLOR_LEVEL_EMOJI = {
    "çº¢è‰²": "ğŸ”´",
    "æ©™è‰²": "ğŸŸ ",
    "é»„è‰²": "ğŸŸ¡",
    "è“è‰²": "ğŸ”µ",
    "ç™½è‰²": "âšª",
}

# é»˜è®¤æ­£æ–‡æè¿°æœ€å¤§é•¿åº¦
DEFAULT_MAX_DESCRIPTION_LENGTH = 384


class WeatherFormatter(BaseMessageFormatter):
    """æ°”è±¡é¢„è­¦æ ¼å¼åŒ–å™¨"""

    @staticmethod
    def format_message(weather: WeatherAlarmData, options: dict = None) -> str:
        """æ ¼å¼åŒ–æ°”è±¡é¢„è­¦æ¶ˆæ¯"""
        if options is None:
            options = {}

        # æå–é¢„è­¦ç±»å‹
        headline = weather.headline or ""
        emoji = "â›ˆï¸"

        for name in SORTED_WEATHER_TYPES:
            if name in headline:
                emoji = WEATHER_EMOJI_MAP[name]
                break

        # æå–é¢„è­¦é¢œè‰²
        color_emoji = ""
        for color, icon in COLOR_LEVEL_EMOJI.items():
            if color in headline:
                color_emoji = icon
                break

        lines = [f"{emoji}[æ°”è±¡é¢„è­¦]"]

        # æ ‡é¢˜
        if weather.headline:
            lines.append(f"ğŸ“‹{weather.headline}{color_emoji}")

        # æè¿°
        if weather.description:
            desc = weather.description
            max_len = options.get(
                "max_description_length", DEFAULT_MAX_DESCRIPTION_LENGTH
            )
            if max_len > 0 and len(desc) > max_len:
                desc = desc[: max_len - 3] + "..."
            lines.append(f"ğŸ“{desc}")

        # å‘å¸ƒæ—¶é—´
        if weather.issue_time:
            lines.append(
                f"â°ç”Ÿæ•ˆæ—¶é—´ï¼š{WeatherFormatter.format_time(weather.issue_time)}"
            )

        return "\n".join(lines)
